<!DOCTYPE html>
<html>
<head>
    <title>Bikaner Fresh Veggies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .order-card { max-width: 500px; margin: 15px auto; padding: 25px; border-radius: 20px; border: none; }
        
        /* DATE PICKER ULTIMATE FIX - Ab ye pakka black dikhega */
        #delivery-date { 
            color: #000000 !important; 
            background-color: #ffffff !important; 
            border: 2px solid #dc3545 !important;
            font-weight: bold !important;
            height: 48px;
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Note Design Fix - Ab ye sundar aur readable hai */
        .rate-warning { 
            font-size: 0.85rem; 
            background: #fff3cd; 
            color: #856404; 
            padding: 12px; 
            border-radius: 10px; 
            border-left: 5px solid #ffc107; 
            margin-top: 10px;
            font-weight: 500;
        }
        
        .ticker-wrap { background: #198754; color: white; padding: 5px 0; font-weight: bold; }
        .product-item { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 5px solid #198754; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="ticker-wrap">
        <marquee id="mandi-ticker" scrollamount="5">üî¥ LIVE BIKANER MANDI BHAV: Loading...</marquee>
    </div>

    <div class="container">
        <div class="card order-card shadow-lg">
            <h2 class="text-center text-success fw-bold">Bikaner Fresh Veggies</h2>
            <p class="text-center text-muted small">‡§§‡§æ‡§ú‡§º‡§æ ‡§∏‡§¨‡•ç‡§ú‡§º‡§ø‡§Ø‡§æ‡§Å - ‡§Æ‡§Ç‡§°‡•Ä ‡§∏‡•á ‡§∏‡•Ä‡§ß‡•á ‡§ò‡§∞ ‡§§‡§ï</p>
            <hr>
            
            <div id="login-section">
                <label class="small fw-bold">Mobile (‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤)</label>
                <input type="number" id="mobile" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç" class="form-control mb-2" oninput="checkReturningCustomer(this.value)">
                
                <label class="small fw-bold text-danger">Delivery Address (‡§™‡§§‡§æ)</label>
                <input type="text" id="address" placeholder="Gali, Mohalla, Area..." class="form-control mb-3">
                
                <label class="small fw-bold text-primary">Delivery Kab Chahiye?</label>
                <select id="delivery-type" class="form-select mb-3" onchange="toggleDateAndUI()">
                    <option value="today">Aaj hi (Urgent Delivery)</option>
                    <option value="future">Future Booking (Advance Booking)</option>
                </select>

                <div id="date-section" style="display:none;" class="mb-3">
                    <label class="small fw-bold text-danger">Delivery Date Chuniye:</label>
                    <input type="date" id="delivery-date" class="form-control">
                    <div class="rate-warning">
                        <b>‚ö†Ô∏è ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç:</b> ‡§¨‡§æ‡§ï‡•Ä 40% ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§µ‡§æ‡§≤‡•á ‡§¶‡§ø‡§® ‡§ï‡•á ‡§Æ‡§Ç‡§°‡•Ä ‡§≠‡§æ‡§µ (Market Rate) ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§π‡•ã‡§ó‡•Ä‡•§
                    </div>
                </div>

                <button onclick="checkLocation()" class="btn btn-primary w-100 fw-bold">Confirm & Shop Now</button>
            </div>
            
            <div id="product-list" class="mt-4"></div>
            
            <div id="checkout-section" style="display:none;" class="mt-4 border-top pt-3">
                <h6 class="fw-bold mb-3">Aapka Cart (‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü)</h6>
                <div id="cart-details"></div>
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded my-2 border">
                    <span class="fw-bold">Total Bill:</span>
                    <span class="fw-bold text-success fs-5">‚Çπ<span id="cart-total">0</span></span>
                </div>
                
                <div id="advance-display-box" style="display:none;" class="p-3 border rounded bg-white text-center mb-3">
                    <h6 class="text-warning fw-bold">Advance Payment (60%): ‚Çπ<span id="advance-amt">0</span></h6>
                    <img id="qr-img" src="" class="img-fluid border p-2" style="max-width: 200px;">
                    <p class="small text-muted mt-2">UPI: 8740871855@ptsbi</p>
                </div>
                
                <button onclick="sendOrder()" class="btn btn-warning w-100 fw-bold py-3 mt-3 shadow">Confirm Order on WhatsApp</button>
            </div>
        </div>
    </div>

    <script>
        let cart = [];
        let productsData = [];

        async function loadMandiBhav() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                document.getElementById('mandi-ticker').innerText = "üî¥ LIVE BIKANER MANDI BHAV: " + data.mandiMessage;
            } catch(e) { }
        }
        loadMandiBhav();

        async function checkReturningCustomer(num) {
            if (num.length === 10) {
                const res = await fetch('/api/customer/get-address', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mobile: num })
                });
                const data = await res.json();
                if (data.address) document.getElementById('address').value = data.address;
            }
        }

        function toggleDateAndUI() {
            const type = document.getElementById('delivery-type').value;
            document.getElementById('date-section').style.display = type === 'future' ? 'block' : 'none';
            updateCartUI();
        }

        async function checkLocation() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch('/api/user/check-radius', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lat: pos.coords.latitude, lng: pos.coords.longitude })
                });
                const data = await res.json();
                if (data.inRadius) loadProducts();
                else alert("Maafi, hum sirf Bikaner mein 5km tak delivery karte hain.");
            });
        }

        async function loadProducts() {
            const res = await fetch('/api/products');
            productsData = await res.json();
            let html = '<h6 class="fw-bold mb-3">Chuniye Sabziyan:</h6>';
            productsData.forEach(p => {
                if (p.stock > 0) {
                    html += `<div class="d-flex justify-content-between align-items-center product-item">
                                <div><span class="fw-bold">${p.name}</span><br><small class="text-muted">‚Çπ${p.price}/${p.unit}</small></div>
                                <button onclick="addToCart('${p._id}')" class="btn btn-outline-success btn-sm fw-bold">Add +</button>
                             </div>`;
                }
            });
            document.getElementById('product-list').innerHTML = html;
            document.getElementById('checkout-section').style.display = 'block';
        }

        function addToCart(id) {
            const prod = productsData.find(p => p._id === id);
            const item = cart.find(i => i._id === id);
            if (item) item.quantity += 1; else cart.push({ ...prod, quantity: 1 });
            updateCartUI();
        }

        function changeQty(id, delta) {
            const item = cart.find(i => i._id === id);
            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) cart = cart.filter(i => i._id !== id);
            }
            updateCartUI();
        }

        function updateCartUI() {
            const type = document.getElementById('delivery-type').value;
            let total = 0;
            let html = '';
            cart.forEach(item => {
                const itemPrice = item.price * item.quantity;
                total += itemPrice;
                html += `<div class="d-flex justify-content-between p-2 border-bottom small">
                            <span><b>${item.name}</b> (${item.quantity}${item.unit})</span>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-light border py-0" onclick="changeQty('${item._id}', -1)">-</button>
                                <span class="mx-2">${item.quantity}</span>
                                <button class="btn btn-sm btn-light border py-0" onclick="changeQty('${item._id}', 1)">+</button>
                            </div>
                         </div>`;
            });
            document.getElementById('cart-total').innerText = total;
            document.getElementById('cart-details').innerHTML = html;

            const advBox = document.getElementById('advance-display-box');
            if (type === 'future' && total > 0) {
                const adv = (total * 0.6).toFixed(2);
                advBox.style.display = 'block';
                document.getElementById('advance-amt').innerText = adv;
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=225x225&data=${encodeURIComponent('upi://pay?pa=8740871855@ptsbi&pn=BikanerFreshVeggies&am='+adv+'&cu=INR')}`;
            } else advBox.style.display = 'none';
        }

        async function sendOrder() {
            const mobile = document.getElementById('mobile').value;
            const address = document.getElementById('address').value;
            const type = document.getElementById('delivery-type').value;
            const date = document.getElementById('delivery-date').value;
            if(!mobile || !address || cart.length === 0) return alert("Details bharein!");
            if(type === 'future' && !date) return alert("Kripya Delivery Date chuniye!");

            const total = parseFloat(document.getElementById('cart-total').innerText);
            const advance = (total * 0.6).toFixed(2);
            const remaining = (total * 0.4).toFixed(2);

            let bill = cart.map(i => `‚Ä¢ ${i.name} (${i.quantity}${i.unit}) = ‚Çπ${i.price * i.quantity}`).join('\n');
            
            let text = `*NAYA ORDER - BIKANER FRESH VEGGIES*\n\n` +
                       `üìÖ *Type:* ${type === 'future' ? 'FUTURE BOOKING' : 'URGENT'}\n` +
                       (type === 'future' ? `üìÜ *Delivery Date:* ${date}\n` : '') +
                       `üìç *Address:* ${address}\n` +
                       `---------------------------\n${bill}\n---------------------------\n` +
                       `üí∞ *Total Bill:* ‚Çπ${total}\n`;
            
            if(type === 'future') {
                text += `‚úÖ *Advance Paid (60%):* ‚Çπ${advance}\n` +
                        `üíµ *Remaining (40%):* ‚Çπ${remaining}\n\n` +
                        `‚ö†Ô∏è *Note:* Baaki ‚Çπ${remaining} delivery wale din ke mandi rate ke hisab se kam ya zyada ho sakte hain.`;
            }

            text += `\nüìû *Contact:* ${mobile}`;
            window.open(`https://wa.me/918740871855?text=${encodeURIComponent(text)}`);
        }
    </script>
</body>
</html>
